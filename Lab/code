
DROP TABLE IF EXISTS order_items;
DROP TABLE IF EXISTS orders;
DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS categories;
DROP TABLE IF EXISTS employees;
DROP TABLE IF EXISTS customers;

CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL
);

CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    position VARCHAR(50) CHECK (position <> '')
);

CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    price DOUBLE PRECISION CHECK (price > 0),
    category_id INTEGER NOT NULL,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    customer_id INTEGER NOT NULL,
    employee_id INTEGER NOT NULL,
    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (employee_id) REFERENCES employees(id)
);

CREATE TABLE order_items (
    order_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    quantity INTEGER CHECK (quantity > 0),
    PRIMARY KEY (order_id, product_id),
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id)
);


INSERT INTO customers (name, email)
VALUES
('Julia Sakhniuk', 'julia@example.com'),
('Ivan Petrenko', 'ivan.p@gmail.com'),
('Petro Ivanov', 'petro@example.com');


INSERT INTO employees (name, position)
VALUES
('Andrii Shevchenko', 'Senior Manager'),
('Olena Koval', 'Consultant'),
('Maria Kozak', 'Sales');


INSERT INTO categories (id, name) VALUES 
(1, 'Electronics'), 
(3, 'Books')
ON CONFLICT DO NOTHING;

INSERT INTO products (name, price, category_id) 
VALUES 
('iPhone 15', 1300, 1),
('Samsung Galaxy S23', 950, 1),
('Sony WH-1000XM5 Headphones', 380, 1),
('Apple Watch Series 9', 550, 1),
('GoPro Hero 11', 420, 1),
('MacBook Pro', 2500, 1),

('Atomic Habits', 25, 3),
('The Pragmatic Programmer', 40, 3),
('Clean Code', 45, 3),
('Harry Potter and the Philosopher''s Stone', 20, 3);


INSERT INTO orders (customer_id, employee_id)
VALUES
(1, 1), 
(2, 2),
(3, 3);


INSERT INTO order_items (order_id, product_id, quantity)
VALUES
(1, 1, 1),  
(1, 7, 2),  
(2, 2, 1),  
(2, 8, 1),  
(3, 6, 1),  
(3, 9, 1);  



SELECT 
    customers.id AS customer_id, 
    customers.name AS customer_name, 
    COUNT(orders.id) AS order_count
FROM customers
LEFT JOIN orders ON customers.id = orders.customer_id
GROUP BY customers.id, customers.name;


SELECT 
    categories.name AS category_name, 
    AVG(products.price) AS average_price
FROM categories
JOIN products ON products.category_id = categories.id
GROUP BY categories.name;


SELECT 
    MIN(order_items.quantity) AS minimum_quantity,
    MAX(order_items.quantity) AS maximum_quantity
FROM order_items;


SELECT 
    products.name AS product_name, 
    SUM(order_items.quantity * products.price) AS total_revenue
FROM order_items
JOIN products ON order_items.product_id = products.id
GROUP BY products.name;


SELECT 
    orders.id AS order_id, 
    customers.name AS customer_name, 
    employees.name AS employee_name
FROM orders
INNER JOIN customers ON orders.customer_id = customers.id
INNER JOIN employees ON orders.employee_id = employees.id;


SELECT 
    products.name AS product_name, 
    categories.name AS category_name
FROM products
LEFT JOIN categories ON products.category_id = categories.id;


SELECT 
    employees.name AS employee_name, 
    customers.name AS customer_name
FROM employees
CROSS JOIN customers;


SELECT 
    orders.id AS order_id,
    (SELECT COUNT(*) FROM order_items WHERE order_items.order_id = orders.id) AS items_count
FROM orders;


SELECT * 
FROM customers
WHERE customers.id IN (
    SELECT DISTINCT orders.customer_id FROM orders
);


SELECT 
    categories.name AS category_name, 
    AVG(products.price) AS average_price
FROM categories
JOIN products ON products.category_id = categories.id
GROUP BY categories.name
HAVING AVG(products.price) > 1000;
